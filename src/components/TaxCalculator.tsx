/******************************************************************
 *  TaxCalculator.tsx  –  FBR-compliant 2025-26 (PKR symbols)
 *  All new slabs verified from FBR circulars / budget docs
 ******************************************************************/
import React, { useState, useMemo } from 'react';
import {
  ArrowLeft,
  Banknote,
  Briefcase,
  Calculator,
  Car,
  Coins,
  Home,
  Info,
  Lightbulb,
  PieChart as PieIcon,
  TrendingUp,
  Users,
  Download,
  Share,
  Copy,
  CheckCircle
} from 'lucide-react';
import {
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Tooltip,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
} from 'recharts';
import { taxCalculator as core, TaxCalculation } from '../services/taxCalculator';

/* Get categories from core service */
const allCategories = core.getTaxCategories();

/* -----------------------------------------------------------
   Component starts here
----------------------------------------------------------- */
export const TaxCalculator: React.FC = () => {
  /* ---------- Screen & inputs ---------- */
  const [step, setStep] = useState<'category' | 'calc'>('category');
  const [categoryId, setCategoryId] = useState('');
  const [period, setPeriod] = useState<'monthly' | 'annual'>('monthly');
  const [rawInput, setRawInput] = useState('');
  const [includeZakat, setIncludeZakat] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const [copied, setCopied] = useState(false);

  const numericInput = useMemo(() => Number(rawInput.replace(/[^\d]/g, '')) || 0, [rawInput]);

  /* ---------- Calculation ---------- */
  const calc: TaxCalculation | null = useMemo(() => {
    if (!categoryId || numericInput <= 0) return null;

    const isMonthlyCapable = ['salary', 'pension', 'property'].includes(categoryId);
    const annual = isMonthlyCapable ? (period === 'monthly' ? numericInput * 12 : numericInput) : numericInput;

    // use core taxCalculator for built-ins, our own for extras
    const catObj = allCategories.find((c) => c.id === categoryId)!;
    return core.calculateTax(categoryId, numericInput, period === 'monthly', includeZakat);
  }, [categoryId, numericInput, period, includeZakat]);

  // Auto-show results when calculation is available
  useEffect(() => {
    if (calc && numericInput > 0) {
      setShowResults(true);
    } else {
      setShowResults(false);
    }
  }, [calc, numericInput]);

  /* ---------- Helpers ---------- */
  const fmt = (n: number) => `₨${n.toLocaleString('en-PK')}`;
  const iconMap: Record<string, React.ElementType> = {
    salary: Users,
    pension: Users,
    business: Briefcase,
    property: Home,
    property236C: Home,
    property236K: Home,
    bankProfit: Banknote,
    dividend: Coins,
    capitalGainsSecurities: TrendingUp,
    builderDeveloper: Home,
    transport: Car,
  };

  const handleCopyResults = async () => {
    if (!calc) return;
    
    const text = `Tax Calculation Results:
Gross Income: ${fmt(calc.grossIncome)}
Total Tax: ${fmt(calc.totalTax)}
Net Income: ${fmt(calc.netIncome)}
Effective Rate: ${calc.effectiveRate.toFixed(1)}%

Generated by Arkive Tax Calculator`;
    
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('Failed to copy:', error);
    }
  };

  const handleExportPDF = () => {
    if (!calc) return;
    
    // Create a simple text export for now
    const data = `Tax Calculation Report
Generated: ${format(new Date(), 'MMMM dd, yyyy')}

Category: ${catObj.name}
Income Period: ${period === 'monthly' ? 'Monthly' : 'Annual'}

CALCULATION RESULTS:
Gross Income: ${fmt(calc.grossIncome)}
Taxable Income: ${fmt(calc.taxableIncome)}
Total Tax: ${fmt(calc.totalTax)}
Net Income: ${fmt(calc.netIncome)}
Effective Tax Rate: ${calc.effectiveRate.toFixed(1)}%

${includeZakat ? 'Zakat (2.5%) included in calculation' : 'Zakat not included'}

Disclaimer: This is an estimate based on Finance Act 2025-26. 
Please consult a qualified tax advisor for precise calculations.`;

    const blob = new Blob([data], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tax-calculation-${format(new Date(), 'yyyy-MM-dd')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
  /* ---------- Category picker ---------- */
  if (step === 'category') {
    return (
      <div className="space-y-8 animate-fadeIn max-w-7xl mx-auto">
        <div className="text-center">
          <div className="mx-auto w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl">
            <Calculator className="w-12 h-12 text-white" />
          </div>
          <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-3">
            Pakistan Tax Calculator 2025-26
          </h1>
          <p className="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
            Select your income type to calculate tax according to Finance Act 2025-26
          </p>
          <div className="mt-4 inline-flex items-center px-4 py-2 bg-blue-50 dark:bg-blue-900/20 rounded-full text-sm text-blue-700 dark:text-blue-300">
            <CheckCircle className="w-4 h-4 mr-2" />
            FBR Compliant • Updated for 2025-26
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {allCategories.map((c) => {
            const Icon = iconMap[c.id] || Calculator;
            return (
              <button
                key={c.id}
                onClick={() => {
                  setCategoryId(c.id);
                  setStep('calc');
                }}
                className="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300 text-left group border border-blue-400/20"
              >
                <div className="flex items-center justify-between mb-4">
                  <Icon className="w-14 h-14 text-blue-100 group-hover:text-white transition-colors" />
                  <div className="w-3 h-3 bg-white/20 rounded-full group-hover:bg-white/40 transition-colors"></div>
                </div>
                <h3 className="text-xl font-bold mb-3 group-hover:text-blue-50 transition-colors">{c.name}</h3>
                <p className="text-sm opacity-90 leading-relaxed group-hover:opacity-100 transition-opacity">{c.description}</p>
                <div className="mt-4 flex items-center text-xs text-blue-200 group-hover:text-blue-100 transition-colors">
                  <span className="w-2 h-2 bg-current rounded-full mr-2"></span>
                  Click to calculate
                </div>
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  /* ---------- Calculation screen ---------- */
  const catObj = allCategories.find((c) => c.id === categoryId)!;
  const isMonthlyCapable = ['salary', 'pension', 'property'].includes(categoryId);

  return (
    <div className="space-y-8 animate-fadeIn max-w-7xl mx-auto">
      <button
        onClick={() => {
          setStep('category');
          setRawInput('');
          setShowResults(false);
        }}
        className="flex items-center gap-2 px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
      >
        <ArrowLeft size={16} /> Back
      </button>

      <div className="text-center">
        <div className="mx-auto w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg">
          {React.createElement(iconMap[categoryId] || Calculator, { className: "w-10 h-10 text-white" })}
        </div>
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">{catObj.name}</h1>
        <p className="text-lg text-gray-600 dark:text-gray-400">{catObj.description}</p>
      </div>

      {/* === INPUT CARD === */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 space-y-6 shadow-xl border border-gray-100 dark:border-gray-700">
        <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
          <Calculator className="w-6 h-6 text-blue-600" />
          Income Details
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
          {isMonthlyCapable && (
            <div>
              <label className="block text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300">Income Period</label>
              <select
                value={period}
                onChange={(e) => setPeriod(e.target.value as any)}
                className="w-full px-4 py-4 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 font-medium"
              >
                <option value="monthly">Monthly</option>
                <option value="annual">Annual</option>
              </select>
            </div>
          )}

          <div className={isMonthlyCapable ? '' : 'col-span-2'}>
            <label className="block text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300">
              {isMonthlyCapable ? `${period === 'monthly' ? 'Monthly' : 'Annual'}` : ''}{' '}
              Income Amount
            </label>
            <div className="relative">
              <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-lg">₨</span>
              <input
                type="text"
                value={rawInput}
                onChange={(e) => {
                  const value = e.target.value.replace(/[^\d]/g, '');
                  setRawInput(value ? parseInt(value).toLocaleString() : '');
                }}
                placeholder="e.g. 1,50,000"
                className="w-full pl-12 pr-4 py-4 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-xl font-bold"
              />
            </div>
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Enter amount in Pakistani Rupees (PKR)
            </p>
          </div>

          {catObj.hasZakat && (
            <div className="flex items-center space-x-3 bg-green-50 dark:bg-green-900/20 rounded-xl p-4">
              <input
                id="zakat"
                type="checkbox"
                checked={includeZakat}
                onChange={(e) => setIncludeZakat(e.target.checked)}
                className="h-5 w-5 text-green-600 rounded focus:ring-2 focus:ring-green-500"
              />
              <label htmlFor="zakat" className="text-sm font-semibold text-green-700 dark:text-green-300">
                Include Zakat (2.5%)
              </label>
            </div>
          )}
        </div>
      </div>

      {/* === RESULT CARDS === */}
      {calc && showResults && (
        <>
          {/* Action Buttons */}
          <div className="flex justify-center gap-4">
            <button
              onClick={handleCopyResults}
              className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl"
            >
              {copied ? <CheckCircle className="w-5 h-5" /> : <Copy className="w-5 h-5" />}
              {copied ? 'Copied!' : 'Copy Results'}
            </button>
            <button
              onClick={handleExportPDF}
              className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-all duration-300 shadow-lg hover:shadow-xl"
            >
              <Download className="w-5 h-5" />
              Export Report
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {[
              { 
                label: 'Gross Income',  
                value: fmt(calc.grossIncome),
                color: 'bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800',
                icon: Coins 
              },
              { 
                label: 'Total Tax', 
                value: fmt(calc.totalTax), 
                color: 'bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 text-red-600 dark:text-red-400 border-red-200 dark:border-red-800',
                icon: Calculator 
              },
              { 
                label: 'Net Income', 
                value: fmt(calc.netIncome), 
                color: 'bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 text-green-600 dark:text-green-400 border-green-200 dark:border-green-800',
                icon: TrendingUp 
              },
              { 
                label: 'Tax Rate', 
                value: `${calc.effectiveRate.toFixed(1)}%`,
                icon: Calculator, 
                color: 'bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 text-purple-600 dark:text-purple-400 border-purple-200 dark:border-purple-800', 
              },
            ].map((c, i) => (
              <div key={i} className={`${c.color} p-8 rounded-2xl shadow-lg border-2 hover-lift transition-all duration-300 group`}>
                <div className="flex items-center justify-between mb-2">
                  <p className="text-sm font-semibold opacity-80 group-hover:opacity-100 transition-opacity">{c.label}</p>
                  <c.icon className="w-6 h-6 opacity-60 group-hover:opacity-80 group-hover:scale-110 transition-all" />
                </div>
                <p className="text-3xl font-bold group-hover:scale-105 transition-transform">{c.value}</p>
              </div>
            ))}
          </div>

          {/* Monthly Take-home for salary */}
          {isMonthlyCapable && (
            <div className="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-2xl p-8 shadow-xl border border-green-400/20">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-2xl font-bold">Monthly Take-home</h3>
                <TrendingUp className="w-8 h-8 text-green-200" />
              </div>
              <p className="text-4xl font-bold mb-2">
                {fmt(Math.round(calc.netIncome / 12))}
              </p>
              <p className="text-green-100 text-base">
                After tax and {includeZakat ? 'zakat' : 'without zakat'}
              </p>
            </div>
          )}

          {/* pie + bar charts */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700">
              <h3 className="text-xl font-semibold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
                <PieIcon className="w-5 h-5 text-blue-600" />
                Income Distribution
              </h3>
              <ResponsiveContainer width="100%" height={280}>
                <PieChart>
                  <Pie
                    data={[
                      { name: 'Net', value: calc.netIncome },
                      { name: 'Tax', value: calc.totalTax },
                    ]}
                    dataKey="value"
                    label={({ name, percent }) => `${name}\n${Math.round(percent * 100)}%`}
                    outerRadius={100}
                    innerRadius={40}
                    paddingAngle={5}
                  >
                    <Cell fill="#10B981" />
                    <Cell fill="#EF4444" />
                  </Pie>
                  <Tooltip 
                    formatter={(v: number) => [fmt(v), '']}
                    contentStyle={{ 
                      backgroundColor: '#ffffff',
                      border: '2px solid #e5e7eb',
                      borderRadius: '12px',
                      boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.1)',
                      fontSize: '14px',
                      fontWeight: 600
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </div>

            <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700">
              <h3 className="text-xl font-semibold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
                <BarChart3 className="w-5 h-5 text-purple-600" />
                Tax Brackets
              </h3>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart
                  data={catObj.taxBrackets.map((b) => ({
                    range: `${(b.min / 1000)}K - ${b.max ? (b.max / 1000) + 'K' : '∞'}`,
                    rate: Math.round(b.rate * 100),
                  }))}
                >
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" className="opacity-50" />
                  <XAxis 
                    dataKey="range" 
                    tick={{ fontSize: 11, fill: '#6b7280', fontWeight: 500 }} 
                    angle={-45} 
                    textAnchor="end" 
                    height={80}
                    axisLine={{ stroke: '#d1d5db', strokeWidth: 2 }}
                  />
                  <YAxis 
                    unit="%" 
                    tick={{ fontSize: 13, fill: '#6b7280', fontWeight: 500 }}
                    axisLine={{ stroke: '#d1d5db', strokeWidth: 2 }}
                  />
                  <Tooltip 
                    formatter={(v: number) => [`${v}%`, 'Tax Rate']}
                    contentStyle={{ 
                      backgroundColor: '#ffffff',
                      border: '2px solid #e5e7eb',
                      borderRadius: '12px',
                      boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.1)',
                      fontSize: '14px',
                      fontWeight: 600
                    }}
                  />
                  <Bar dataKey="rate" fill="#8B5CF6" radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* tips & disclaimer */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-8 rounded-2xl border-2 border-blue-200 dark:border-blue-800">
            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2 text-blue-900 dark:text-blue-100">
              <Lightbulb className="w-5 h-5 text-yellow-500" />
              Tax Saving Tips
            </h3>
            <ul className="space-y-3 text-sm text-blue-800 dark:text-blue-200">
              {core.getTaxSavingTips(categoryId, calc.grossIncome).map((t, i) => (
                <li key={i} className="flex items-start gap-2">
                  <span className="w-2 h-2 bg-yellow-500 rounded-full mt-2 shrink-0"></span>
                  <span className="font-medium">{t}</span>
                </li>
              ))}
            </ul>
          </div>

          <div className="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border-2 border-yellow-200 dark:border-yellow-800 rounded-2xl p-8">
            <div className="flex items-start gap-2">
              <Info className="w-6 h-6 text-yellow-600 dark:text-yellow-400 mt-1" />
              <div>
                <p className="font-bold text-yellow-800 dark:text-yellow-200 mb-2 text-lg">Important Disclaimer</p>
                <p className="text-yellow-700 dark:text-yellow-300 font-medium">
                  These are estimates based on Finance Act 2025-26. Please consult a qualified tax advisor for precise calculations and filing requirements.
                </p>
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
};